class BeastValidator{constructor(t,{errorContainerClass:e="beast-error-msg",tooltipClass:a="beast-tooltip",focusFirst:i=!0,validateOnChange:s=!0,tooltips:r="none",helperText:n=!0,shakeInput:o=!0,waitForDom:l=!0,setNoValidate:h=!0,autoSubmit:d=!0,initSteps:c=!1,debug:m=!1,onFail:u=null,onSuccess:g=null,onInit:p=null,onStepChange:f=null,language:v="en",theme:y="beast",submitTo:S=null,errorSummaryTarget:b=null}={}){this.errorContainerClass=e,this.tooltipClass=a,this.focusFirst=i,this.validateOnChange=s,this.tooltips=r,this.helperText=n,this.shakeInput=o,this.waitForDom=l,this.setNoValidate=h,this.autoSubmit=d,this.initSteps=c,this.debug=m,this.onFail=u,this.onSuccess=g,this.onInit=p,this.onStepChange=f,this.language=v,this.theme=y,this.submitTo=S,this.errorSummaryTarget=b,this.form=null,this.customValidators={},this.log("[INIT] BeastValidator instantiated"),!0===this.waitForDom?document.addEventListener("DOMContentLoaded",()=>{this.initialize(t)}):this.initialize(t)}initialize(t){if(this.log("[INIT] Initializing validator"),this.form="string"==typeof t?document.getElementById(t):t,!this.form)return void this.log("[INIT] No form found. Initialization aborted.","error");this.setNoValidate&&this.form.setAttribute("novalidate","true"),this.initLanguage(),this.attachListener();const e=this.getAllFields();this.log(`[INIT] Found ${e.length} fields`),e.forEach(t=>{t.name?t.dataset.beastId=t.name:t.dataset.beastId=this.randomString(8)}),this.errorSummaryTarget&&this.setErrorSummaryTarget(this.errorSummaryTarget,{icon:"⚠️",heading:"Errors found:",scrollTo:!0}),!0===this.initSteps&&(this.currentStep=1,this.showStep(this.currentStep),this.log("[INIT] Step flow initialized")),"function"==typeof this.onInit&&(this.log("[INIT] onInit callback triggered"),this.onInit())}initLanguage(){this.messages={en:{required:"This field is required",email:"Please enter a valid email address",minlength:t=>`Minimum length is ${t} characters`,maxlength:t=>`Maximum length is ${t} characters`,minValue:t=>`Must be at least ${t}`,maxValue:t=>`Must be at most ${t}`,match:"Values do not match",invalidFormat:"Invalid format"},da:{required:"Dette felt er påkrævet",email:"Indtast en gyldig e-mailadresse",minlength:t=>`Minimumslængde er ${t} tegn`,maxlength:t=>`Maksimallængde er ${t} tegn`,minValue:t=>`Skal være mindst ${t}`,maxValue:t=>`Må højst være ${t}`,match:"Værdierne stemmer ikke overens",invalidFormat:"Ugyldigt format"},de:{required:"Dieses Feld ist erforderlich",email:"Bitte geben Sie eine gültige E-Mail-Adresse ein",minlength:t=>`Mindestens ${t} Zeichen erforderlich`,maxlength:t=>`Maximal ${t} Zeichen erlaubt`,minValue:t=>`Mindestens ${t} erforderlich`,maxValue:t=>`Höchstens ${t} erlaubt`,match:"Die Werte stimmen nicht überein",invalidFormat:"Ungültiges Format"},pirate:{required:"Ye gotta fill this in, matey!",email:"That be no proper sea-mail address!",minlength:t=>`Ye need at least ${t} scraggly letters`,maxlength:t=>`Whoa! No more than ${t} runes, ye scallywag!`,minValue:t=>`Ye need at least ${t} doubloons`,maxValue:t=>`No more than ${t}, or ye’ll walk the plank!`,match:"These don’t be matchin’, ye landlubber!",invalidFormat:"That be a cursed format, it is!"}}}reset(){this.log("[RESET] Clearing form state and errors"),this.clearErrors(),this.form.querySelectorAll('[data-dirty="dirty"]').forEach(t=>{delete t.dataset.dirty})}attachListener(){const t=this.getAllFields();this.form.addEventListener("submit",async t=>{this.log("[EVENT] Submit triggered"),t.preventDefault();const e=this.form.querySelector('button[type="submit"]');e&&this.deactivateButton(e),this.log("[VALIDATION] Starting form validation");const a=await this.validate();this.log(`[VALIDATION] Validation result: ${a}`),a?(this.log("[EVENT] Form valid. Proceeding to submission."),this.autoSubmit?this.form.submit():this.activateButton(e)):(this.log("[EVENT] Form invalid. Submission aborted."),this.activateButton(e))}),this.validateOnChange&&t.forEach(t=>{t.addEventListener("change",()=>{this.log(`[EVENT] Change detected on "${t.name}"`),this.validateField(t)}),t.addEventListener("input",()=>{"dirty"===t.dataset.dirty&&(this.log(`[EVENT] Input on dirty field "${t.name}"`),this.validateField(t))})}),this.form.querySelectorAll("[data-next]").forEach(t=>{t.addEventListener("click",async()=>{const e=this.form.querySelector(`[data-step="${this.currentStep}"]`),a=e&&e.hasAttribute("data-validate");this.log(`[STEP] Next button clicked. Full validation? ${a}`),this.deactivateButton(t),await new Promise(t=>setTimeout(t,300));(a?await this.validate():await this.validateCurrentStep())&&this.nextStep(),this.activateButton(t)})}),this.form.addEventListener("keydown",async t=>{if("Enter"===t.key){const e=this.form.querySelector(`[data-step="${this.currentStep}"]`);if(!e)return;const a=["INPUT"].includes(t.target.tagName),i="submit"===t.target.type;if(a&&!i){const t=e.querySelector("[data-next]");t&&(this.deactivateButton(t),await new Promise(t=>setTimeout(t,300)));const a=e.hasAttribute("data-validate"),i=a?await this.validate():await this.validateCurrentStep();this.log(`[STEP] Enter clicked. Full validation? ${a}`),t&&this.activateButton(t),i&&this.nextStep()}}}),this.form.querySelectorAll("[data-prev]").forEach(t=>{t.addEventListener("click",async e=>{this.deactivateButton(t),await new Promise(t=>setTimeout(t,300)),this.prevStep(),this.activateButton(t)})})}async validate(){this.log("[VALIDATION] Running validate()"),this.log(`[VALIDATION] Using language "${this.language}"`);const t=this.getAllFields(),e=new Set;let a=!0,i=null;const s=[];this.clearErrors();const r=Array.from(t).map(async t=>{const r=t.type,n=t.name;if("radio"===r&&e.has(n))return;"radio"===r&&e.add(n);const o=await this.validateField(t);this.log(`[VALIDATION] Field "${n}" valid: ${o}`),o||(s.push(t),i||(i=t),a=!1)});if(await Promise.all(r),!a&&i)this.log("[VALIDATION] Invalid fields detected"),i.scrollIntoView({behavior:"smooth",block:"center"}),i.focus({preventScroll:!0}),"function"==typeof this.onFail&&this.onFail(s),this.errorSummaryTarget&&this.renderErrorSummary(s);else if(a){this.errorSummaryTarget&&(this.errorSummaryTarget.innerHTML="");const t=this.getFormDataAsObject();"function"==typeof this.onSuccess&&this.onSuccess(t),this.submitTo?.url&&this.submitForm(t)}return a}submitForm(t){const e=this.submitTo.url,a=this.submitTo.method||"POST",i={"Content-Type":"application/json",...this.submitTo.headers||{}},s=JSON.stringify("function"==typeof this.submitTo.transform?this.submitTo.transform(t):t);this.log(`[API] Submitting to ${e} with method ${a}`),fetch(e,{method:a,headers:i,body:s}).then(async t=>{const e=t.headers.get("content-type")?.includes("application/json"),a=e?await t.json():await t.text();if(this.log(`[API] Response status: ${t.status}`),this.log(`[API] Response body: ${JSON.stringify(a)}`),!t.ok)throw this.log(`[API] Submission failed: ${JSON.stringify(err)}`,"error"),{status:t.status,data:a};this.submitTo.onResponse?.(a,t)}).catch(t=>{this.submitTo.onError?.(t)})}getFormDataAsObject(){const t={};return this.getAllFields().forEach(e=>{e.name&&!e.disabled&&("radio"===e.type?e.checked&&(t[e.name]=e.value):"checkbox"===e.type?(t[e.name]||(t[e.name]=[]),e.checked&&t[e.name].push(e.value)):t[e.name]=e.value)}),t}async validateField(t){this.log(`[VALIDATION] Validating field "${t.name}", type "${t.type}"`),this.clearErrorsFor(t),t.classList.add("validating");const e=parseFloat(t.dataset.sleep||"0");e>0&&""!==t.value&&(this.log(`[ASYNC] Sleeping for ${e}s`),await new Promise(t=>setTimeout(t,1e3*e)));const{valid:a,errorMessage:i,errorTarget:s}=await this.runValidationRules(t);return t.classList.remove("validating"),this.clearThemeClasses(t),a?(delete t.dataset.dirty,this.applyThemeClass(t,"valid"),this.log(`[VALIDATION] Field "${t.name}" passed`)):(t.dataset.dirty="dirty",this.renderError(t,i,s),this.applyThemeClass(t,"invalid")),a}async runValidationRules(t){t.name;const e=t.type,a=(this.form,this.messages[this.language]||{});let i=!0,s="",r=t;if(await this.checkRequired(t)||(i=!1,s=t.dataset.errorMessage||a.required||"This field is required"),i&&"checkbox"===e&&t.dataset.min){const e=this.checkCheckboxGroupMin(t);e.valid||(i=!1,s=e.message,r=e.errorTarget)}if(i&&t.dataset.match&&t.value&&(this.checkMatch(t)||(i=!1,s=a.match||"Values do not match")),i&&t.hasAttribute("minlength")&&t.value){const e=parseInt(t.getAttribute("minlength"),10);t.value.length<e&&(i=!1,s=a.minlength?.(e)||`Minimum length is ${e}`)}if(i&&(t.dataset.min||t.dataset.max)&&t.value){const e=this.checkNumericRange(t);e.valid||(i=!1,s=e.message)}if(i&&t.hasAttribute("pattern")&&t.value&&(this.checkPattern(t)||(i=!1,s=a.invalidFormat||"Invalid format")),i&&t.hasAttribute("maxlength")&&t.value){const e=parseInt(t.getAttribute("maxlength"),10);t.value.length>e&&(i=!1,s=a.maxlength?.(e)||`Maximum length is ${e}`)}if(i&&"email"===e&&t.value&&(this.checkEmail(t.value)||(i=!1,s=a.email||"Please enter a valid email address")),i&&t.dataset.validator){const e=await this.checkCustomValidator(t);!0!==e&&(i=!1,s="string"==typeof e?e:"Invalid value")}return{valid:i,errorMessage:s,errorTarget:r}}renderError(t,e,a){if(this.log(`[VALIDATION] Field "${t.name}" failed: ${e}`),this.createTooltip(t,a,e),this.helperText){const i=t.dataset.errorContainer,s=i?document.getElementById(i):null;if(s)s.textContent=e,s.dataset.referenceId=t.dataset.beastId;else{this.clearErrorsFor(t);const i=document.createElement("div");i.className=this.errorContainerClass,i.dataset.referenceId=t.dataset.beastId,i.textContent=e,a.insertAdjacentElement("afterend",i)}}this.shakeInput&&(t.classList.add("shake"),t.addEventListener("animationend",()=>{t.classList.remove("shake")},{once:!0}))}validateCurrentStep(){const t=this.currentStep,e=this.form.querySelectorAll(`[data-step="${t}"] input, [data-step="${t}"] select, [data-step="${t}"] textarea`);let a=!0,i=null;const s=[];this.clearErrors();const r=Array.from(e).map(async t=>{await this.validateField(t)||(i||(i=t),a=!1,s.push(t))});return Promise.all(r).then(()=>(!a&&i&&(i.scrollIntoView({behavior:"smooth",block:"center"}),i.focus({preventScroll:!0}),"function"==typeof this.onFail&&this.onFail(s),this.errorSummaryTarget&&this.renderErrorSummary(s)),a))}clearErrors(){this.log("[VALIDATION] Clearing all error messages"),this.getAllFields().forEach(t=>{this.clearErrorsFor(t)})}clearErrorsFor(t){const e=t.dataset.beastId,a=document.querySelectorAll(`[data-reference-id="${e}"]`);this.log(`[UI] Clearing errors for field "${t.name||"[unnamed]"}"`),a.forEach(t=>{t.classList.contains(this.tooltipClass)?t.remove():t.id?t.innerHTML="":t.remove()}),this.clearThemeClasses(t)}log(t,e="debug"){this.debug&&("warn"===e?console.warn(t):"error"===e?console.error(t):console.log(`[${(new Date).toISOString()}] ${t}`))}randomString(t=8){const e="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";return Array.from({length:t},()=>e.charAt(Math.floor(52*Math.random()))).join("")}createTooltip(t,e,a){if("none"==this.tooltips)return;const i=this.tooltips;this.log(`[UI] Showing tooltip for "${t.name||"[unnamed]"}" at ${i}`);const s=e.parentElement;"static"===getComputedStyle(s).position&&(s.style.position="relative");const r=document.createElement("div");r.className=this.tooltipClass,r.textContent=a,r.dataset.referenceId=t.dataset.beastId,r.style.position="absolute",r.style.zIndex="9999",r.style.pointerEvents="none",r.style.visibility="hidden",s.appendChild(r);const{top:n,left:o}=this.getTooltipCoordinates(e,r,i);this.log(`[UI] Tooltip coordinates: top=${n}, left=${o}`),r.style.left=`${o}px`,r.style.top=`${n}px`,r.style.visibility="visible"}renderErrorSummary(t){if(!this.errorSummaryTarget)return;this.log(`[SUMMARY] Rendering error summary for ${t.length} fields`),this.errorSummaryOptions={scrollTo:!0,heading:"Please fix the following:",icon:"❌"};const{scrollTo:e,heading:a,icon:i}=this.errorSummaryOptions,s=this.errorSummaryTarget;s.innerHTML="";const r=document.createElement("div");if(r.className="beast-summary-box",a){const t=document.createElement("strong");t.textContent=`${i} ${a}`,r.appendChild(t)}const n=document.createElement("ul");n.className="beast-summary-list",t.forEach(t=>{const a=t.getAttribute("aria-label")||t.getAttribute("placeholder")||t.dataset.label||t.name||"[unnamed]",i=document.querySelector(`[data-reference-id="${t.dataset.beastId}"]`),s=i?.textContent||"Invalid field",r=document.createElement("li"),o=document.createElement("a");o.href="#",o.textContent=`${a}: ${s}`,o.addEventListener("click",a=>{a.preventDefault(),e&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.focus({preventScroll:!0}))}),r.appendChild(o),n.appendChild(r)}),r.appendChild(n),s.appendChild(r)}getTooltipCoordinates(t,e,a="top-center"){const i=e.getBoundingClientRect(),s=(t.getBoundingClientRect(),t.offsetLeft),r=t.offsetTop;let n,o;switch(a){case"top-left":n=s;break;case"top-right":n=s+t.offsetWidth-i.width;break;default:n=s+t.offsetWidth/2-i.width/2}return o=r-i.height-8,{top:o,left:n}}deactivateButton(t){t&&(t.disabled=!0,t.dataset.originalText=t.innerHTML,t.textContent="Validating...")}activateButton(t){t&&(t.disabled=!1,t.textContent=t.dataset.originalText)}applyThemeClass(t,e){if("none"===this.theme)return;const a={beast:{valid:"valid",invalid:"invalid"},bootstrap:{valid:"is-valid",invalid:"is-invalid"}}[this.theme]?.[e];a&&t.classList.add(a)}setTheme(t){this.theme=t,this.log(`[THEME] Theme set to "${t}"`)}setLanguage(t){this.messages[t]?(this.language=t,this.log(`[LANG] Language set to "${t}"`)):this.log(`[WARN] Language "${t}" not found`)}setMessages(t,e){this.messages[t]={...this.messages[t]||{},...e}}addMessage(t,e,a){this.messages[t]||(this.messages[t]={}),this.messages[t][e]=a}getAllFields(){return this.form.querySelectorAll("input, textarea, select")}clearThemeClasses(t){if("none"===this.theme)return;({beast:["valid","invalid"],bootstrap:["is-valid","is-invalid"]}[this.theme]||[]).forEach(e=>t.classList.remove(e))}showStep(t){document.querySelectorAll("[data-step]").forEach(e=>{const a=parseInt(e.dataset.step,10);e.style.display=a===t?"block":"none"}),this.currentStep=t,this.log(`[STEP] Showing step ${t}`),"function"==typeof this.onStepChange&&this.onStepChange(t)}nextStep(){if(this.currentStep<document.querySelectorAll("[data-step]").length){const t=this.currentStep+1;this.log(`[STEP] Switching from step ${this.currentStep} to ${t}`),this.showStep(t)}else this.log("[STEP] Already at last step, cannot go forward")}prevStep(){if(this.currentStep>1){const t=this.currentStep-1;this.log(`[STEP] Switching from step ${this.currentStep} to ${t}`),this.showStep(t)}else this.log("[STEP] Already at first step, cannot go backward")}addValidator(t,e){this.log(`[CUSTOM] Adding custom validator "${t}"`),this.customValidators[t]=e}setErrorSummaryTarget(t,e={}){const a=document.querySelector(t);a?(this.errorSummaryTarget=a,this.errorSummaryOptions={...this.errorSummaryOptions,...e},this.log(`[SUMMARY] Bound to ${t}`)):this.log(`[SUMMARY] Target "${t}" not found`)}checkRequired(t){const e=t.type,a=t.name,i=this.form;return!t.hasAttribute("required")||("checkbox"===e?t.checked:"radio"===e?!!i.querySelector(`input[type="radio"][name="${a}"]:checked`):"file"===e?t.files.length>0:""!==t.value.trim())}checkCheckboxGroupMin(t){const e=t.name,a=parseInt(t.dataset.min,10),i=this.form.querySelectorAll(`input[type="checkbox"][name="${e}"]`);return Array.from(i).filter(t=>t.checked).length<a?{valid:!1,message:`Select at least ${a}`,errorTarget:i[i.length-1]}:{valid:!0}}checkPattern(t){const e=t.pattern;return new RegExp(`^(?:${e})$`).test(t.value)}checkMatch(t){const e=t.dataset.match,a=this.form.querySelector(`[name="${e}"]`);return a&&a.value===t.value}checkEmail(t){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)}checkNumericRange(t){const e=parseFloat(t.value);if(isNaN(e))return{valid:!0};const a=parseFloat(t.dataset.min),i=parseFloat(t.dataset.max);return!isNaN(a)&&e<a?{valid:!1,message:this.messages[this.language]?.minValue?.(a)||`Must be at least ${a}`}:!isNaN(i)&&e>i?{valid:!1,message:this.messages[this.language]?.maxValue?.(i)||`Must be at most ${a}`}:{valid:!0}}async checkCustomValidator(t){const e=t.dataset.validator,a=this.customValidators[e];if("function"==typeof a){const i=await a(t);return this.log(`[CUSTOM] Validator "${e}" returned: ${i}`),i}return this.log(`[WARN] Custom validator "${e}" not found`),!0}}