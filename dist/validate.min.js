!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).BeastValidator=e()}(this,function(){"use strict";class t{constructor(t,{errorContainerClass:e="beast-error-msg",tooltipClass:a="beast-tooltip",focusFirst:s=!0,validateOnChange:i=!0,tooltips:r="none",helperText:n=!0,shakeInput:o=!0,waitForDom:l=!0,setNoValidate:d=!0,autoSubmit:h=!0,initSteps:m=!1,debug:c=!1,onFail:u=null,onSuccess:g=null,onInit:p=null,onStepChange:f=null,language:v="en",theme:y="beast",submitTo:S=null,errorSummaryTarget:b=null}={}){this.errorContainerClass=e,this.tooltipClass=a,this.focusFirst=s,this.validateOnChange=i,this.tooltips=r,this.helperText=n,this.shakeInput=o,this.waitForDom=l,this.setNoValidate=d,this.autoSubmit=h,this.initSteps=m,this.debug=c,this.onFail=u,this.onSuccess=g,this.onInit=p,this.onStepChange=f,this.language=v,this.theme=y,this.submitTo=S,this.errorSummaryTarget=b,this.form=null,this.customValidators={},this.log("[INIT] BeastValidator instantiated"),!0===this.waitForDom?document.addEventListener("DOMContentLoaded",()=>{this.initialize(t)}):this.initialize(t)}initialize(t){if(this.log("[INIT] Initializing validator"),this.form="string"==typeof t?document.getElementById(t):t,!this.form)return void this.log("[INIT] No form found. Initialization aborted.","error");this.setNoValidate&&this.form.setAttribute("novalidate","true"),this.initLanguage(),this.attachListener();const e=this.getAllFields();this.log(`[INIT] Found ${e.length} fields`),e.forEach(t=>{t.name?t.dataset.beastId=t.name:t.dataset.beastId=this.randomString(8)}),this.errorSummaryTarget&&this.setErrorSummaryTarget(this.errorSummaryTarget,{icon:"⚠️",heading:"Errors found:",scrollTo:!0}),!0===this.initSteps&&(this.currentStep=1,this.showStep(this.currentStep),this.log("[INIT] Step flow initialized")),"function"==typeof this.onInit&&(this.log("[INIT] onInit callback triggered"),this.onInit())}initLanguage(){this.messages={en:{required:"This field is required",email:"Please enter a valid email address",minlength:t=>`Minimum length is ${t} characters`,maxlength:t=>`Maximum length is ${t} characters`,minValue:t=>`Must be at least ${t}`,maxValue:t=>`Must be at most ${t}`,minAge:t=>`You must be at least ${t} years old`,maxAge:t=>`You must be no older than ${t} years old`,passwordStrength_weak:"Password must be at least 6 characters",passwordStrength_medium:"Password must be at least 8 characters and include a number",passwordStrength_strong:"Password must be at least 10 characters and include uppercase, lowercase, number, and symbol",match:"Values do not match",invalidFormat:"Invalid format"},da:{required:"Dette felt er påkrævet",email:"Indtast en gyldig e-mailadresse",minlength:t=>`Minimumslængde er ${t} tegn`,maxlength:t=>`Maksimallængde er ${t} tegn`,minValue:t=>`Skal være mindst ${t}`,maxValue:t=>`Må højst være ${t}`,minAge:t=>`Du skal være mindst ${t} år gammel`,maxAge:t=>`Du må højst være ${t} år gammel`,passwordStrength_weak:"Adgangskoden skal være mindst 6 tegn lang",passwordStrength_medium:"Mindst 8 tegn og ét tal kræves",passwordStrength_strong:"Mindst 10 tegn med stort, småt, tal og symbol kræves",match:"Værdierne stemmer ikke overens",invalidFormat:"Ugyldigt format"},de:{required:"Dieses Feld ist erforderlich",email:"Bitte geben Sie eine gültige E-Mail-Adresse ein",minlength:t=>`Mindestens ${t} Zeichen erforderlich`,maxlength:t=>`Maximal ${t} Zeichen erlaubt`,minValue:t=>`Mindestens ${t} erforderlich`,maxValue:t=>`Höchstens ${t} erlaubt`,minAge:t=>`Du musst mindestens ${t} Jahre alt sein`,maxAge:t=>`Du darfst höchstens ${t} Jahre alt sein`,passwordStrength_weak:"Das Passwort muss mindestens 6 Zeichen lang sein",passwordStrength_medium:"Mindestens 8 Zeichen und eine Zahl erforderlich",passwordStrength_strong:"Mindestens 10 Zeichen, Groß-/Kleinbuchstaben, Zahl und Symbol erforderlich",match:"Die Werte stimmen nicht überein",invalidFormat:"Ungültiges Format"},pirate:{required:"Ye gotta fill this in, matey!",email:"That be no proper sea-mail address!",minlength:t=>`Ye need at least ${t} scraggly letters`,maxlength:t=>`Whoa! No more than ${t} runes, ye scallywag!`,minValue:t=>`Ye need at least ${t} doubloons`,maxValue:t=>`No more than ${t}, or ye’ll walk the plank!`,minAge:t=>`Ye need to be at least ${t} summers old, ye wee swabbie`,maxAge:t=>`Over ${t}? That’s ancient, ye barnacle!`,passwordStrength_weak:"Yer secret be too short — at least 6 runes!",passwordStrength_medium:"Needs 8 runes and at least one shiny number, ye dog!",passwordStrength_strong:"A proper pirate pass be 10+ runes, big letters, small letters, cursed symbols, and digits!",match:"These don’t be matchin’, ye landlubber!",invalidFormat:"That be a cursed format, it is!"}}}reset(){this.log("[RESET] Clearing form state and errors"),this.clearErrors(),this.form.querySelectorAll('[data-dirty="dirty"]').forEach(t=>{delete t.dataset.dirty})}attachListener(){const t=this.getAllFields();this.form.addEventListener("submit",async t=>{this.log("[EVENT] Submit triggered"),t.preventDefault();const e=this.form.querySelector('button[type="submit"]');e&&this.deactivateButton(e),this.log("[VALIDATION] Starting form validation");const a=await this.validate();this.log(`[VALIDATION] Validation result: ${a}`),a?(this.log("[EVENT] Form valid. Proceeding to submission."),this.autoSubmit?this.form.submit():this.activateButton(e)):(this.log("[EVENT] Form invalid. Submission aborted."),this.activateButton(e))}),this.validateOnChange&&t.forEach(t=>{t.addEventListener("change",()=>{this.log(`[EVENT] Change detected on "${t.name}"`),this.validateField(t)}),t.addEventListener("input",()=>{"dirty"===t.dataset.dirty&&(this.log(`[EVENT] Input on dirty field "${t.name}"`),this.validateField(t))})}),this.form.querySelectorAll("[data-next]").forEach(t=>{t.addEventListener("click",async()=>{const e=this.form.querySelector(`[data-step="${this.currentStep}"]`),a=e&&e.hasAttribute("data-validate");this.log(`[STEP] Next button clicked. Full validation? ${a}`),this.deactivateButton(t),await new Promise(t=>setTimeout(t,300));(a?await this.validate():await this.validateCurrentStep())&&this.nextStep(),this.activateButton(t)})}),this.form.addEventListener("keydown",async t=>{if("Enter"===t.key){const e=this.form.querySelector(`[data-step="${this.currentStep}"]`);if(!e)return;const a=["INPUT"].includes(t.target.tagName),s="submit"===t.target.type;if(a&&!s){const t=e.querySelector("[data-next]");t&&(this.deactivateButton(t),await new Promise(t=>setTimeout(t,300)));const a=e.hasAttribute("data-validate"),s=a?await this.validate():await this.validateCurrentStep();this.log(`[STEP] Enter clicked. Full validation? ${a}`),t&&this.activateButton(t),s&&this.nextStep()}}}),this.form.querySelectorAll("[data-prev]").forEach(t=>{t.addEventListener("click",async e=>{this.deactivateButton(t),await new Promise(t=>setTimeout(t,300)),this.prevStep(),this.activateButton(t)})})}async validate(){this.log("[VALIDATION] Running validate()"),this.log(`[VALIDATION] Using language "${this.language}"`);const t=this.getAllFields(),e=new Set;let a=!0,s=null;const i=[];this.clearErrors();const r=Array.from(t).map(async t=>{const r=t.type,n=t.name;if("radio"===r&&e.has(n))return;"radio"===r&&e.add(n);const o=await this.validateField(t);this.log(`[VALIDATION] Field "${n}" valid: ${o}`),o||(i.push(t),s||(s=t),a=!1)});if(await Promise.all(r),!a&&s)this.log("[VALIDATION] Invalid fields detected"),s.scrollIntoView({behavior:"smooth",block:"center"}),s.focus({preventScroll:!0}),"function"==typeof this.onFail&&this.onFail(i),this.errorSummaryTarget&&this.renderErrorSummary(i);else if(a){this.errorSummaryTarget&&(this.errorSummaryTarget.innerHTML="");const t=this.getFormDataAsObject();"function"==typeof this.onSuccess&&this.onSuccess(t),this.submitTo?.url&&this.submitForm(t)}return a}submitForm(t){const e=this.submitTo.url,a=this.submitTo.method||"POST",s={"Content-Type":"application/json",...this.submitTo.headers||{}},i=JSON.stringify("function"==typeof this.submitTo.transform?this.submitTo.transform(t):t);this.log(`[API] Submitting to ${e} with method ${a}`),fetch(e,{method:a,headers:s,body:i}).then(async t=>{const e=t.headers.get("content-type")?.includes("application/json"),a=e?await t.json():await t.text();if(this.log(`[API] Response status: ${t.status}`),this.log(`[API] Response body: ${JSON.stringify(a)}`),!t.ok)throw this.log(`[API] Submission failed: ${JSON.stringify(err)}`,"error"),{status:t.status,data:a};this.submitTo.onResponse?.(a,t)}).catch(t=>{this.submitTo.onError?.(t)})}getFormDataAsObject(){const t={};return this.getAllFields().forEach(e=>{e.name&&!e.disabled&&("radio"===e.type?e.checked&&(t[e.name]=e.value):"checkbox"===e.type?(t[e.name]||(t[e.name]=[]),e.checked&&t[e.name].push(e.value)):t[e.name]=e.value)}),t}async validateField(t){this.log(`[VALIDATION] Validating field "${t.name}", type "${t.type}"`),this.clearErrorsFor(t),t.classList.add("validating");const e=parseFloat(t.dataset.sleep||"0");e>0&&""!==t.value&&(this.log(`[ASYNC] Sleeping for ${e}s`),await new Promise(t=>setTimeout(t,1e3*e)));const{valid:a,errorMessage:s,errorTarget:i}=await this.runValidationRules(t);return t.classList.remove("validating"),this.clearThemeClasses(t),a?(delete t.dataset.dirty,this.applyThemeClass(t,"valid"),this.log(`[VALIDATION] Field "${t.name}" passed`)):(t.dataset.dirty="dirty",this.renderError(t,s,i),this.applyThemeClass(t,"invalid")),a}async runValidationRules(t){t.name;const e=t.type;this.form;const a=this.messages[this.language]||{};let s=!0,i="",r=t;if(await this.checkRequired(t)||(s=!1,i=t.dataset.errorMessage||a.required||"This field is required"),s&&"checkbox"===e&&t.dataset.min){const e=this.checkCheckboxGroupMin(t);e.valid||(s=!1,i=e.message,r=e.errorTarget)}if(s&&t.dataset.match&&t.value&&(this.checkMatch(t)||(s=!1,i=a.match||"Values do not match")),s&&t.hasAttribute("minlength")&&t.value){const e=parseInt(t.getAttribute("minlength"),10);t.value.length<e&&(s=!1,i=a.minlength?.(e)||`Minimum length is ${e}`)}if(s&&(t.dataset.min||t.dataset.max)&&t.value){const e=this.checkNumericRange(t);e.valid||(s=!1,i=e.message)}if(s&&t.hasAttribute("pattern")&&t.value&&(this.checkPattern(t)||(s=!1,i=a.invalidFormat||"Invalid format")),s&&t.hasAttribute("maxlength")&&t.value){const e=parseInt(t.getAttribute("maxlength"),10);t.value.length>e&&(s=!1,i=a.maxlength?.(e)||`Maximum length is ${e}`)}if(s&&"email"===e&&t.value&&(this.checkEmail(t.value)||(s=!1,i=a.email||"Please enter a valid email address")),s&&(t.dataset.minAge||t.dataset.maxAge)&&t.value){const e=this.checkAge(t);e.valid||(s=!1,i=e.message)}if(s&&t.dataset.passwordStrength&&t.value){const e=this.checkPasswordStrength(t);e.valid||(s=!1,i=e.message)}if(s&&t.dataset.validator){const e=await this.checkCustomValidator(t);!0!==e&&(s=!1,i="string"==typeof e?e:"Invalid value")}return{valid:s,errorMessage:i,errorTarget:r}}renderError(t,e,a){if(this.log(`[VALIDATION] Field "${t.name}" failed: ${e}`),this.createTooltip(t,a,e),this.helperText){const s=t.dataset.errorContainer,i=s?document.getElementById(s):null;if(i)i.textContent=e,i.dataset.referenceId=t.dataset.beastId;else{this.clearErrorsFor(t);const s=document.createElement("div");s.className=this.errorContainerClass,s.dataset.referenceId=t.dataset.beastId,s.textContent=e,a.insertAdjacentElement("afterend",s)}}this.shakeInput&&(t.classList.add("shake"),t.addEventListener("animationend",()=>{t.classList.remove("shake")},{once:!0}))}validateCurrentStep(){const t=this.currentStep,e=this.form.querySelectorAll(`[data-step="${t}"] input, [data-step="${t}"] select, [data-step="${t}"] textarea`);let a=!0,s=null;const i=[];this.clearErrors();const r=Array.from(e).map(async t=>{await this.validateField(t)||(s||(s=t),a=!1,i.push(t))});return Promise.all(r).then(()=>(!a&&s&&(s.scrollIntoView({behavior:"smooth",block:"center"}),s.focus({preventScroll:!0}),"function"==typeof this.onFail&&this.onFail(i),this.errorSummaryTarget&&this.renderErrorSummary(i)),a))}clearErrors(){this.log("[VALIDATION] Clearing all error messages"),this.getAllFields().forEach(t=>{this.clearErrorsFor(t)})}clearErrorsFor(t){const e=t.dataset.beastId,a=document.querySelectorAll(`[data-reference-id="${e}"]`);this.log(`[UI] Clearing errors for field "${t.name||"[unnamed]"}"`),a.forEach(t=>{t.classList.contains(this.tooltipClass)?t.remove():t.id?t.innerHTML="":t.remove()}),this.clearThemeClasses(t)}log(t,e="debug"){this.debug&&("warn"===e?console.warn(t):"error"===e?console.error(t):console.log(`[${(new Date).toISOString()}] ${t}`))}randomString(t=8){const e="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";return Array.from({length:t},()=>e.charAt(Math.floor(52*Math.random()))).join("")}createTooltip(t,e,a){if("none"==this.tooltips)return;const s=this.tooltips;this.log(`[UI] Showing tooltip for "${t.name||"[unnamed]"}" at ${s}`);const i=e.parentElement;"static"===getComputedStyle(i).position&&(i.style.position="relative");const r=document.createElement("div");r.className=this.tooltipClass,r.textContent=a,r.dataset.referenceId=t.dataset.beastId,r.style.position="absolute",r.style.zIndex="9999",r.style.pointerEvents="none",r.style.visibility="hidden",i.appendChild(r);const{top:n,left:o}=this.getTooltipCoordinates(e,r,s);this.log(`[UI] Tooltip coordinates: top=${n}, left=${o}`),r.style.left=`${o}px`,r.style.top=`${n}px`,r.style.visibility="visible"}renderErrorSummary(t){if(!this.errorSummaryTarget)return;this.log(`[SUMMARY] Rendering error summary for ${t.length} fields`),this.errorSummaryOptions={scrollTo:!0,heading:"Please fix the following:",icon:"❌"};const{scrollTo:e,heading:a,icon:s}=this.errorSummaryOptions,i=this.errorSummaryTarget;i.innerHTML="";const r=document.createElement("div");if(r.className="beast-summary-box",a){const t=document.createElement("strong");t.textContent=`${s} ${a}`,r.appendChild(t)}const n=document.createElement("ul");n.className="beast-summary-list",t.forEach(t=>{const a=t.getAttribute("aria-label")||t.getAttribute("placeholder")||t.dataset.label||t.name||"[unnamed]",s=document.querySelector(`[data-reference-id="${t.dataset.beastId}"]`),i=s?.textContent||"Invalid field",r=document.createElement("li"),o=document.createElement("a");o.href="#",o.textContent=`${a}: ${i}`,o.addEventListener("click",a=>{a.preventDefault(),e&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.focus({preventScroll:!0}))}),r.appendChild(o),n.appendChild(r)}),r.appendChild(n),i.appendChild(r)}getTooltipCoordinates(t,e,a="top-center"){const s=e.getBoundingClientRect();t.getBoundingClientRect();const i=t.offsetLeft,r=t.offsetTop;let n,o;switch(a){case"top-left":n=i;break;case"top-right":n=i+t.offsetWidth-s.width;break;default:n=i+t.offsetWidth/2-s.width/2}return o=r-s.height-8,{top:o,left:n}}deactivateButton(t){t&&(t.disabled=!0,t.dataset.originalText=t.innerHTML,t.textContent="Validating...")}activateButton(t){t&&(t.disabled=!1,t.textContent=t.dataset.originalText)}applyThemeClass(t,e){if("none"===this.theme)return;const a={beast:{valid:"valid",invalid:"invalid"},bootstrap:{valid:"is-valid",invalid:"is-invalid"}}[this.theme]?.[e];a&&t.classList.add(a)}setTheme(t){this.theme=t,this.log(`[THEME] Theme set to "${t}"`)}setLanguage(t){this.messages[t]?(this.language=t,this.log(`[LANG] Language set to "${t}"`)):this.log(`[WARN] Language "${t}" not found`)}setMessages(t,e){this.messages[t]={...this.messages[t]||{},...e}}addMessage(t,e,a){this.messages[t]||(this.messages[t]={}),this.messages[t][e]=a}getAllFields(){return this.form.querySelectorAll("input, textarea, select")}clearThemeClasses(t){if("none"===this.theme)return;({beast:["valid","invalid"],bootstrap:["is-valid","is-invalid"]}[this.theme]||[]).forEach(e=>t.classList.remove(e))}showStep(t){document.querySelectorAll("[data-step]").forEach(e=>{const a=parseInt(e.dataset.step,10);e.style.display=a===t?"block":"none"}),this.currentStep=t,this.log(`[STEP] Showing step ${t}`),"function"==typeof this.onStepChange&&this.onStepChange(t)}nextStep(){if(this.currentStep<document.querySelectorAll("[data-step]").length){const t=this.currentStep+1;this.log(`[STEP] Switching from step ${this.currentStep} to ${t}`),this.showStep(t)}else this.log("[STEP] Already at last step, cannot go forward")}prevStep(){if(this.currentStep>1){const t=this.currentStep-1;this.log(`[STEP] Switching from step ${this.currentStep} to ${t}`),this.showStep(t)}else this.log("[STEP] Already at first step, cannot go backward")}addValidator(t,e){this.log(`[CUSTOM] Adding custom validator "${t}"`),this.customValidators[t]=e}setErrorSummaryTarget(t,e={}){const a=document.querySelector(t);a?(this.errorSummaryTarget=a,this.errorSummaryOptions={...this.errorSummaryOptions,...e},this.log(`[SUMMARY] Bound to ${t}`)):this.log(`[SUMMARY] Target "${t}" not found`)}checkRequired(t){const e=t.type,a=t.name,s=this.form;return!t.hasAttribute("required")||("checkbox"===e?t.checked:"radio"===e?!!s.querySelector(`input[type="radio"][name="${a}"]:checked`):"file"===e?t.files.length>0:""!==t.value.trim())}checkCheckboxGroupMin(t){const e=t.name,a=parseInt(t.dataset.min,10),s=this.form.querySelectorAll(`input[type="checkbox"][name="${e}"]`);return Array.from(s).filter(t=>t.checked).length<a?{valid:!1,message:`Select at least ${a}`,errorTarget:s[s.length-1]}:{valid:!0}}checkPattern(t){const e=t.pattern;return new RegExp(`^(?:${e})$`).test(t.value)}checkMatch(t){const e=t.dataset.match,a=this.form.querySelector(`[name="${e}"]`);return a&&a.value===t.value}checkEmail(t){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)}checkNumericRange(t){const e=parseFloat(t.value);if(isNaN(e))return{valid:!0};const a=parseFloat(t.dataset.min),s=parseFloat(t.dataset.max);return!isNaN(a)&&e<a?{valid:!1,message:this.messages[this.language]?.minValue?.(a)||`Must be at least ${a}`}:!isNaN(s)&&e>s?{valid:!1,message:this.messages[this.language]?.maxValue?.(s)||`Must be at most ${a}`}:{valid:!0}}checkAge(t){const e=t.value;if(!e)return{valid:!0};const a=new Date(e),s=new Date,i=s.getFullYear()-a.getFullYear(),r=s.getMonth()-a.getMonth(),n=i-(r<0||0===r&&s.getDate()<a.getDate()?1:0),o=parseInt(t.dataset.minAge,10),l=parseInt(t.dataset.maxAge,10),d=this.messages[this.language]||{};return!isNaN(o)&&n<o?{valid:!1,message:d.minAge?.(o)||`You must be at least ${o} years old`}:!isNaN(l)&&n>l?{valid:!1,message:d.maxAge?.(l)||`You must be no older than ${l} years old`}:{valid:!0}}checkPasswordStrength(t){const e=t.dataset.passwordStrength,a=t.value,s=this.messages[this.language]||{};let i=!0;const r={weak:/.{6,}/,medium:/^(?=.*[a-zA-Z])(?=.*\d).{8,}$/,strong:/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{10,}$/};if(i=(r[e]||r.medium).test(a),!i){return{valid:!1,message:s[`passwordStrength_${e}`]||`Password is not ${e} enough`}}return{valid:!0}}async checkCustomValidator(t){const e=t.dataset.validator,a=this.customValidators[e];if("function"==typeof a){const s=await a(t);return this.log(`[CUSTOM] Validator "${e}" returned: ${s}`),s}return this.log(`[WARN] Custom validator "${e}" not found`),!0}}return"undefined"!=typeof window&&(window.BeastValidator=t),t});
